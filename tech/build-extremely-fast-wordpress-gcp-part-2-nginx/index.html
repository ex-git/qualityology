<!DOCTYPE html><html class="has-navbar-fixed-top"><head><meta charset="utf-8"><title>Build an extremely fast WordPress with GCP Part 2: Nginx - Qualityology - Let&#39;s get the most out of life!</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="preconnect" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="preconnect" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="preconnect" href="//ajax.googleapis.com"><link rel="dns-prefetch" href="//ajax.googleapis.com"><meta name="description" content="Apache or Nginx, what softwares should be used to for your server to achieve the maximum performance? If you have a small free server from GCP from part 1, and you want it to be able to handle average"><meta property="og:type" content="article"><meta property="og:title" content="Build an extremely fast WordPress with GCP Part 2: Nginx"><meta property="og:url" content="https://www.qualityology.com/tech/build-extremely-fast-wordpress-gcp-part-2-nginx/index.html"><meta property="og:site_name" content="Qualityology - Let&#39;s get the most out of life!"><meta property="og:description" content="Apache or Nginx, what softwares should be used to for your server to achieve the maximum performance? If you have a small free server from GCP from part 1, and you want it to be able to handle average"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.qualityology.com/2017/09/loading-test-result.png"><meta property="article:published_time" content="2017-10-01T05:11:32.000Z"><meta property="article:modified_time" content="2021-02-24T03:37:09.302Z"><meta property="article:author" content="Evan Xu"><meta property="article:tag" content="WordPress"><meta property="article:tag" content="Nginx"><meta property="article:tag" content="Server"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.qualityology.com/2017/09/loading-test-result.png"><link rel="alternative" href="/rss.xml" title="Build an extremely fast WordPress with GCP Part 2: Nginx" type="aapplication/rss+xml"><link rel="alternative" href="/atom.xml" title="Build an extremely fast WordPress with GCP Part 2: Nginx" type="application/atom+xml"><link rel="alternative" href="/feed.json" title="Build an extremely fast WordPress with GCP Part 2: Nginx" type="application/json"><link rel="icon" type="image/png" href="/assets/logo.png"><link rel="apple-touch-icon" href="/assets/logo_160.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/logo_304.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/logo_360.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/logo_334.png"><meta name="apple-mobile-web-app-title" content="Build an extremely fast WordPress with GCP Part 2: Nginx - Qualityology - Let&#39;s get the most out of life!"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.9.2/css/bulma.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto&display=swap"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/style.css"><script>const pageLoaded=()=>{const o=window.adsbygoogle||[];o.push({}),o.push({})}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-6144848-7"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-6144848-7")</script><meta name="generator" content="Hexo 5.4.0"></head><body onload="pageLoaded()"><nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><a class="navbar-item navbar-logo" href="/"><img src="/assets/loading.gif" data-original="/assets/logo.png" alt height="28"></a><div class="navbar-burger"><span></span> <span></span> <span></span></div></div><div class="navbar-menu navbar-start"><span class="navbar-item"><a href="/lifestyle">Lifestyle </a></span><span class="navbar-item is-active"><a href="/tech">Technology</a></span></div><div class="navbar-menu navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></nav><section class="section"><div class="container"><article class="article content gallery" itemscope itemprop="blogPost"><h1 class="article-title is-size-4 is-size-4-mobile" itemprop="name">Build an extremely fast WordPress with GCP Part 2: Nginx</h1><div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile"><span class="column is-narrow"><time datetime="2017-10-01T05:11:32.000Z" itemprop="datePublished">Sep 30 2017</time> </span><span class="column is-narrow article-category"><i class="far fa-folder"></i> <a class="article-category-link" href="/tech/">tech</a> </span><span class="column is-narrow">5 minutes read (About 794 words)</span></div><div class="article-entry is-size-6-mobile" itemprop="articleBody"><p>Apache or Nginx, what softwares should be used to for your server to achieve the maximum performance? If you have a small free server from GCP from <a href="https://www.qualityology.com/tech/build-an-extremely-fast-wordpress-gcp-part1-server/">part 1</a>, and you want it to be able to handle average 1000 clients per second, Nginx is the best option. Apache use more server resources and must be configured properly to get the best performance. Nginx can handle very large amount of traffic even in a limited environment. We have done the loading test with the server from Google Cloud Platform from <a href="https://www.qualityology.com/tech/build-an-extremely-fast-wordpress-gcp-part1-server/">part 1</a>&#xA0;and the result was great without deep optimization. 1000 client/sec is not the maximum that this setup can get, it is the limit of the free test we could get. <img src="/assets/loading.gif" data-original="/2017/09/loading-test-result.png"> When we tried the same test using Apache, the test was aborted at the beginning because server crashed. That is why we will use Nginx. We are not the server expert, so we will not discuss how to optimize Apache to pass the same test. What we will need is NGINX + MySQL + PHP-FPM +&#xA0;Microcaching + WordPress.</p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6914615778368190" data-ad-slot="9746105168" data-ad-format="auto" data-full-width-responsive="true"></ins><h2 id="Step-1-install-Nginx"><a href="#Step-1-install-Nginx" class="headerlink" title="Step 1, install Nginx."></a>Step 1, install Nginx.</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt-get install nginx -y</span><br><span class="line">sudo service nginx start</span><br></pre></td></tr></table></figure><h2 id="Step-2-install-Mysql-or-MariaDB"><a href="#Step-2-install-Mysql-or-MariaDB" class="headerlink" title="Step 2, install Mysql (or MariaDB)."></a>Step 2, install Mysql (or MariaDB).</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mysql-server -y</span><br><span class="line">sudo service mysql stop</span><br><span class="line">sudo mysql_install_db # follow instructions</span><br><span class="line">sudo service mysql start</span><br><span class="line">sudo mysql_secure_installation # follow instructions</span><br></pre></td></tr></table></figure><h2 id="Step-3-install-Install-PHP-FPM"><a href="#Step-3-install-Install-PHP-FPM" class="headerlink" title="Step 3, install Install PHP-FPM"></a>Step 3, install Install PHP-FPM</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install php-fpm php-mysql php-gd php-cli php-xml php-mbstring</span><br></pre></td></tr></table></figure><p>Add cgi.fix_pathinfo=0 to php.ini, if you know how to add, jump to step 4, otherwise, continue below.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># if you use different version of PHP, change 7.0 to your version e.g. 8.0</span><br><span class="line">sudo nano /etc/php/7.0/fpm/php.ini</span><br><span class="line"></span><br><span class="line"># paste cgi.fix_pathinfo=0</span><br><span class="line"># press ctrl + X key, and type Y to save the file.</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># restart PHP-FPM service</span><br><span class="line"># if you use different version of PHP, change the 7.0 accordingly</span><br><span class="line">sudo service php7.0-fpm restart</span><br></pre></td></tr></table></figure><h2 id="Step-4-configure-Nginx-to-use-PHP-FPM-to-process-php-files"><a href="#Step-4-configure-Nginx-to-use-PHP-FPM-to-process-php-files" class="headerlink" title="Step 4, configure Nginx to use PHP-FPM to process php files"></a>Step 4, configure Nginx to use PHP-FPM to process php files</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/nginx/sites-available/default</span><br><span class="line"></span><br><span class="line"># add the following to the server { } block</span><br><span class="line"></span><br><span class="line">                location ~ \.php$ {</span><br><span class="line">                try_files $uri =404;</span><br><span class="line">                fastcgi_split_path_info ^(.+\.php)(/.+)$;</span><br><span class="line">                fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;</span><br><span class="line">                fastcgi_index index.php;</span><br><span class="line">                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">                include fastcgi_params;</span><br><span class="line">                        }</span><br></pre></td></tr></table></figure><p>Restart Nginx</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure><h2 id="Step-5-add-Microcaching-to-Nginx"><a href="#Step-5-add-Microcaching-to-Nginx" class="headerlink" title="Step 5, add Microcaching to Nginx"></a>Step 5, add Microcaching to Nginx</h2><p>With Microcaching, Nginx can handle large amount of traffic because dynamic inquiries/files are cached to prevent overloading your database. For example if each client to your website generate 2 database inquiry, 1000 client will have 2000 inquires. If you set up cache for 5 seconds, 1000 clients within 5 seconds will only hit your database 2 times if both inquires are cached. That is the magic of this setup.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># always backup the file you want to change</span><br><span class="line">sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak</span><br><span class="line">sudo nano /etc/nginx/sites-available/default</span><br></pre></td></tr></table></figure><p>Add the following to the file. You can add this before the server {} block</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Microcaching</span><br><span class="line">fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=qualityology-com:100m inactive=60m;</span><br><span class="line">fastcgi_cache_key &quot;$scheme$request_method$host$request_uri&quot;;</span><br></pre></td></tr></table></figure><p>Add the following to location ~ \.php$ {} block. Below configuration will set the cache to expire after 10 seconds, and no cache for logged in users and commenters. You can change the 10s to longer time, but 10s is long enough for your need.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#Cache everything by default</span><br><span class="line">set $no_cache 0;</span><br><span class="line"></span><br><span class="line">#Don&apos;t cache logged in users or commenters</span><br><span class="line">if ( $http_cookie ~* &quot;comment_author_wordpress_(?!test_cookie)wp-postpass_&quot; ) {</span><br><span class="line">        set $no_cache 1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#Don&apos;t cache the following URLs</span><br><span class="line">if ($request_uri ~* &quot;/(wp-admin/wp-login.php)&quot;)</span><br><span class="line">{</span><br><span class="line">        set $no_cache 1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">#matches keys_zone in fastcgi_cache_path</span><br><span class="line">fastcgi_cache qualityology-com;</span><br><span class="line"></span><br><span class="line">#don&apos;t serve pages defined earlier</span><br><span class="line">fastcgi_cache_bypass $no_cache;</span><br><span class="line"></span><br><span class="line">#don&apos;t cache pages defined earlier</span><br><span class="line">fastcgi_no_cache $no_cache;</span><br><span class="line"></span><br><span class="line">#defines the default cache time</span><br><span class="line">fastcgi_cache_valid any 10s;</span><br><span class="line"></span><br><span class="line">#unsure what the impacts of this variable is</span><br><span class="line">fastcgi_max_temp_file_size 2M;</span><br><span class="line"></span><br><span class="line">#Use stale cache items while updating in the background</span><br><span class="line">fastcgi_cache_use_stale updating error timeout invalid_header http_500;</span><br><span class="line">fastcgi_cache_lock on;</span><br><span class="line">fastcgi_cache_lock_timeout 10s;</span><br></pre></td></tr></table></figure><p>Test if your configuration</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure><p>If no error, reload your Nginx or restart it</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx start</span><br></pre></td></tr></table></figure><h2 id="Step-6-install-WordPress"><a href="#Step-6-install-WordPress" class="headerlink" title="Step 6, install WordPress"></a>Step 6, install WordPress</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html/</span><br><span class="line">sudo wget http://wordpress.org/latest.tar.gz</span><br><span class="line">sudo tar xzvf latest.tar.gz</span><br><span class="line">sudo rm latest.tar.gz</span><br><span class="line">sudo mv wordpress/* ./</span><br><span class="line">sudo chown -R www-data:www-data /var/www/html/*</span><br></pre></td></tr></table></figure><p>You are all set. Now, open your domain or IP to setup WordPress</p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6914615778368190" data-ad-slot="2953513567" data-ad-format="auto" data-full-width-responsive="true"></ins></div><div class="columns is-variable is-1 is-multiline is-mobile"><span class="column is-narrow"><a class="tag is-light article-tag" href="/tag/wordpress/">#WordPress</a></span> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tag/nginx/">#Nginx</a></span> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tag/server/">#Server</a></span></div><div class="columns is-mobile is-multiline article-nav"><span class="column is-12-mobile is-half-desktop article-nav-prev"><a href="/tech/edit-hosts-file-to-override-dns-record-for-domains/">Edit Hosts file to override DNS record for domains</a> </span><span class="column is-12-mobile is-half-desktop article-nav-next"><a href="/tech/iphones-battery-draining-heres-what-you-can-do/">iPhone&#39;s battery draining? Here&#39;s what you can do</a></span></div></article><div class="sharebox"><div class="sharethis-inline-share-buttons"></div><script async type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=6030430e289b2f0011212bb6&amp;product=sop"></script></div><div class="comments"><h3 class="title is-4">Comments</h3><div id="isso-thread" data-title="Build an extremely fast WordPress with GCP Part 2: Nginx"></div><script async data-isso="//comments.qualityology.com" src="//comments.qualityology.com/js/embed.min.js" data-isso-require-author="true" data-isso-require-email="true" data-isso-avatar="false" data-isso-gravatar="true" data-isso-vote="true" data-isso-reveal-on-click="true"></script></div></div></section><footer class="footer"><div class="container"><div class="columns content"><div class="column is-narrow has-text-centered">&copy; 2021 Qualityology&nbsp;</div><div class="column is-hidden-mobile"></div></div></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/js/all.min.js"></script><script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>window.FontAwesomeConfig={searchPseudoElements:!0},moment.locale("en-AU")</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><style>.hljs{position:relative}.hljs .clipboard-btn{float:right;color:#9a9a9a;background:0 0;border:none;cursor:pointer}.hljs .clipboard-btn:hover{color:#8a8a8a}.hljs>.clipboard-btn{display:none;position:absolute;right:4px;top:4px}.hljs:hover>.clipboard-btn{display:inline}.hljs>figcaption>.clipboard-btn{margin-right:4px}</style><script>$(document).ready(function(){$("figure.hljs").each(function(t,e){var a="code-"+t,r=e.querySelector(".code"),t=$('<button>Copy <i class="far fa-clipboard"></i></button>');r.id=a,t.addClass("clipboard-btn"),t.attr("data-clipboard-target-id",a);a=e.querySelector("figcaption");a?a.append(t[0]):e.prepend(t[0])}),new ClipboardJS(".clipboard-btn",{target:function(t){return document.getElementById(t.getAttribute("data-clipboard-target-id"))}}).on("success",function(t){t.clearSelection()})})</script><script src="/js/script.js"></script><div class="searchbox ins-search"><div class="searchbox-mask"></div><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input type="text" class="searchbox-input ins-search-input" placeholder="Type something..."> <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 3,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>