<!DOCTYPE html><html class="has-navbar-fixed-top"><head><meta charset="utf-8"><title>Let Docker and UFW Firewall work together | Tech | Qualityology</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="preconnect" href="//cdnjs.cloudflare.com"><link rel="dns-prefetch" href="//cdnjs.cloudflare.com"><link rel="preconnect" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="preconnect" href="//ajax.googleapis.com"><link rel="dns-prefetch" href="//ajax.googleapis.com"><link rel="canonical" href="https://www.qualityology.com/tech/let-docker-and-ufw-firewall-work-together/"><meta name="description" content="If you see your Docker container ports got exposed and bypassed all UFW rules, that is normal because Docker will manipulate iptables when creating container. Docker in default will work with iptables"><meta property="og:type" content="article"><meta property="og:title" content="Let Docker and UFW Firewall work together"><meta property="og:url" content="https://www.qualityology.com/tech/let-docker-and-ufw-firewall-work-together/index.html"><meta property="og:site_name" content="Qualityology - Let&#39;s get the most out of life!"><meta property="og:description" content="If you see your Docker container ports got exposed and bypassed all UFW rules, that is normal because Docker will manipulate iptables when creating container. Docker in default will work with iptables"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.qualityology.com/2021/firewall.jpg"><meta property="article:published_time" content="2021-03-06T16:08:50.000Z"><meta property="article:modified_time" content="2021-03-07T07:13:33.436Z"><meta property="article:author" content="Evan Xu"><meta property="article:tag" content="Server"><meta property="article:tag" content="Docker"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.qualityology.com/2021/firewall.jpg"><link rel="icon" type="image/png" href="/assets/logo.png"><link rel="apple-touch-icon" href="/assets/logo_160.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/logo_304.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/logo_360.png"><link rel="apple-touch-icon" sizes="167x167" href="/assets/logo_334.png"><meta name="apple-mobile-web-app-title" content="Let Docker and UFW Firewall work together | Tech | Qualityology"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.9.2/css/bulma.min.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto&display=swap"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css"><link rel="stylesheet" href="/css/style.css"><script>const pageLoaded=()=>{const o=window.adsbygoogle||[];o.push({}),o.push({})}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-6144848-7"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-6144848-7")</script><meta name="generator" content="Hexo 5.4.0"></head><body onload="pageLoaded()"><nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><a class="navbar-item navbar-logo" href="/"><img src="/assets/loading.gif" data-original="/assets/logo.png" alt height="28"></a><div class="navbar-burger"><span></span> <span></span> <span></span></div></div><div class="navbar-menu navbar-start"><span class="navbar-item"><a href="/lifestyle">Lifestyle </a></span><span class="navbar-item is-active"><a href="/tech">Technology</a></span></div><div class="navbar-menu navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a><div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc"><a class="navbar-item" title="Table of Contents"><i class="fa fa-list"></i></a><div class="navbar-dropdown is-right"><a class="navbar-item" href="#Prevent-Docker-from-manipulating-iptables">1&nbsp;&nbsp;<b>Prevent Docker from manipulating iptables</b></a><hr class="navbar-divider"><a class="navbar-item" href="#Put-Docker-behind-UFW">2&nbsp;&nbsp;<b>Put Docker behind UFW</b></a></div></div></div></div></nav><section class="section"><div class="container"><article class="article content gallery" itemscope itemprop="blogPost"><h1 class="article-title is-size-4 is-size-4-mobile" itemprop="name">Let Docker and UFW Firewall work together</h1><div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile"><span class="column is-narrow"><time datetime="2021-03-06T16:08:50.000Z" itemprop="datePublished">Mar 6 2021</time> </span><span class="column is-narrow article-category"><i class="far fa-folder"></i> <a class="article-category-link" href="/tech/">tech</a> </span><span class="column is-narrow">3 minutes read (About 481 words)</span></div><div class="article-entry is-size-6-mobile" itemprop="articleBody"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6914615778368190" data-ad-slot="9746105168" data-ad-format="auto" data-full-width-responsive="true"></ins><p>If you see your Docker container ports got exposed and bypassed all UFW rules, that is normal because Docker will manipulate iptables when creating container. Docker in default will work with iptables nicely without user creating complicated iptables rules. If you don&#x2019;t want Docker creating iptables rules or you are using UFW, you need to propertly configure them to make then work nicely together.</p><p><img src="/assets/loading.gif" data-original="/2021/firewall.jpg" alt="firewall"></p><p><strong>There are two ways to prevent Docker exposing itself with iptables.</strong></p><ol><li><h2 id="Prevent-Docker-from-manipulating-iptables"><a href="#Prevent-Docker-from-manipulating-iptables" class="headerlink" title="Prevent Docker from manipulating iptables"></a>Prevent Docker from manipulating iptables</h2><p>According to <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.docker.com/network/iptables/#prevent-docker-from-manipulating-iptables">Docker&#x2019;s guides</a>, it is possible to set the <code>iptables</code> key to <code>false</code> in the Docker engine&#x2019;s configuration file at <code>/etc/docker/daemon.json</code></p><p>You can achieve that by running below command</p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo bash -c <span class="hljs-string">&apos;echo &quot;{</span></span><br><span class="line"><span class="hljs-string">\&quot;iptables\&quot;: false</span></span><br><span class="line"><span class="hljs-string">}&quot; &gt;&gt; /etc/docker/daemon.json&apos;</span></span><br></pre></td></tr></table></figure></li><li><h2 id="Put-Docker-behind-UFW"><a href="#Put-Docker-behind-UFW" class="headerlink" title="Put Docker behind UFW"></a>Put Docker behind UFW</h2><ol><li><p>Get your external interface name</p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">echo</span> $(ip route get 8.8.8.8 | awk -- <span class="hljs-string">&apos;{printf $5}&apos;</span>)</span><br></pre></td></tr></table></figure></li><li><p>Add the following to the end of <code>/etc/ufw/after.rules</code>. Replace <code>eth0</code> with the interface name you got from previous step. Most common interface name is <code>eth0</code></p><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># sudo nano /etc/ufw/after.rules</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># BEGIN UFW AND DOCKER</span></span><br><span class="line">*filter</span><br><span class="line">:ufw-user-forward - [0:0]</span><br><span class="line">:ufw-docker-logging-deny - [0:0]</span><br><span class="line">:DOCKER-USER - [0:0]</span><br><span class="line">-A DOCKER-USER -j ufw-user-forward</span><br><span class="line"></span><br><span class="line">-A DOCKER-USER -j RETURN -s 10.0.0.0/8</span><br><span class="line">-A DOCKER-USER -j RETURN -s 172.16.0.0/12</span><br><span class="line">-A DOCKER-USER -j RETURN -s 192.168.0.0/16</span><br><span class="line"></span><br><span class="line">-A DOCKER-USER -p udp -m udp --sport 53 --dport 1024:65535 -j RETURN</span><br><span class="line"></span><br><span class="line">-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16</span><br><span class="line">-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8</span><br><span class="line">-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12</span><br><span class="line">-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 192.168.0.0/16</span><br><span class="line">-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 10.0.0.0/8</span><br><span class="line">-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 172.16.0.0/12</span><br><span class="line"></span><br><span class="line">-A DOCKER-USER -j RETURN</span><br><span class="line"></span><br><span class="line">-A ufw-docker-logging-deny -m <span class="hljs-built_in">limit</span> --<span class="hljs-built_in">limit</span> 3/min --limit-burst 10 -j LOG --log-prefix <span class="hljs-string">&quot;[UFW DOCKER BLOCK] &quot;</span></span><br><span class="line">-A ufw-docker-logging-deny -j DROP</span><br><span class="line"></span><br><span class="line">COMMIT</span><br><span class="line"><span class="hljs-comment"># END UFW AND DOCKER</span></span><br></pre></td></tr></table></figure></li><li><p>Remove <code>&quot;iptables&quot;: &quot;false&quot;</code> from <code>etc/docker/daemon.json</code></p></li><li><p>Make sure <code>DEFAULT_FORWARD_POLICY=&quot;DROP&quot;</code> in <code>/etc/default/ufw</code></p></li><li><p>If you ever add any docker related rules to <code>/etc/ufw/before.rules</code>, remove them.</p></li><li><p>Test before reboot</p></li><li><p>Open ports based on your needed. You can allow port access to all containers or specific container.</p><p>To allow public access to port 8080.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw route allow proto tcp from any to any port 8080</span><br></pre></td></tr></table></figure><p>Allow public access to port 80 for container with private address <code>172.17.0.3</code></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw route allow proto tcp from any to 172.17.0.3 port 80</span><br></pre></td></tr></table></figure><p>Allow DNS</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw route allow proto udp from any to any port 53</span><br></pre></td></tr></table></figure></li></ol></li></ol></div><div class="columns is-variable is-1 is-multiline is-mobile"><span class="column is-narrow"><a class="tag is-light article-tag" href="/tag/server/">#Server</a></span> <span class="column is-narrow"><a class="tag is-light article-tag" href="/tag/docker/">#Docker</a></span></div><div class="columns is-mobile is-multiline article-nav"><span class="column is-12-mobile is-half-desktop article-nav-prev"><a href="/tech/ubuntu-port-53-already-in-use-how-to-free-the-dns-port/">Ubuntu port 53 already in use. How to free the DNS port</a> </span><span class="column is-12-mobile is-half-desktop article-nav-next"><a href="/tech/install-isso-server-free-with-gcp/">Install Isso server free with GCP</a></span></div></article><div class="sharebox"><div class="sharethis-inline-share-buttons"></div><script async type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=6030430e289b2f0011212bb6&amp;product=sop"></script></div><div class="comments"><h3 class="title is-4">Comments</h3><div id="isso-thread" data-title="Let Docker and UFW Firewall work together"></div><script async data-isso="//comments.qualityology.com" src="//comments.qualityology.com/js/embed.min.js" data-isso-require-author="true" data-isso-require-email="true" data-isso-avatar="false" data-isso-gravatar="true" data-isso-vote="true" data-isso-reveal-on-click="true"></script></div></div></section><footer class="footer"><div class="container"><div class="columns content"><div class="column is-narrow has-text-centered">&copy; 2021 Qualityology&nbsp;</div><div class="column is-hidden-mobile"></div></div></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/js/all.min.js"></script><script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>window.FontAwesomeConfig={searchPseudoElements:!0},moment.locale("en-AU")</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><style>.hljs{position:relative}.hljs .clipboard-btn{float:right;color:#9a9a9a;background:0 0;border:none;cursor:pointer}.hljs .clipboard-btn:hover{color:#8a8a8a}.hljs>.clipboard-btn{display:none;position:absolute;right:4px;top:4px}.hljs:hover>.clipboard-btn{display:inline}.hljs>figcaption>.clipboard-btn{margin-right:4px}</style><script>$(document).ready(function(){$("figure.hljs").each(function(t,e){var a="code-"+t,r=e.querySelector(".code"),t=$('<button>Copy <i class="far fa-clipboard"></i></button>');r.id=a,t.addClass("clipboard-btn"),t.attr("data-clipboard-target-id",a);a=e.querySelector("figcaption");a?a.append(t[0]):e.prepend(t[0])}),new ClipboardJS(".clipboard-btn",{target:function(t){return document.getElementById(t.getAttribute("data-clipboard-target-id"))}}).on("success",function(t){t.clearSelection()})})</script><script src="/js/script.js"></script><div class="searchbox ins-search"><div class="searchbox-mask"></div><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input type="text" class="searchbox-input ins-search-input" placeholder="Type something..."> <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 3,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>