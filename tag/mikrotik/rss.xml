<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://www.qualityology.com</id>
    <title>Qualityology - Let&#39;s get the most out of life! â€¢ Posts by &#34;mikrotik&#34; tag</title>
    <link href="https://www.qualityology.com" />
    <updated>2019-02-14T22:39:03.000Z</updated>
    <category term="tech" />
    <category term="lifestyle" />
    <entry>
        <id>https://www.qualityology.com/tech/easy-dual-wan-load-balancing-with-mikrotik-routeros-pcc//</id>
        <title>Easy Dual WAN Load Balancing with MikroTik RouterOS PCC</title>
        <link rel="alternate" href="https://www.qualityology.com/tech/easy-dual-wan-load-balancing-with-mikrotik-routeros-pcc/"/>
        <content type="html">&lt;p&gt;RouterOS&amp;#x2019;s load balancing is simple but tricky. Even Mikrotik shows an example of how to configure PCC for load balancing. It does not say how to implement it with dynamic IP. The method introduced here is simple. We will add lease scripts to WAN1 and WAN2. RouterOS will run the script to add the correct gateway IP and firewall rules to make the load balancing work.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Requirements:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1. Name your WAN ports as WAN1 and WAN2. Your bridge as bridge.&lt;br&gt;2. Basic knowledge of RouterOS&lt;br&gt;3. Turn off fasttrack. Yes. It must be off. Otherwise, router can&amp;#x2019;t mark traffic and distribute to both WANs. Disable the firewall filter with action &amp;#x201C;fasttrack-connection&amp;#x201D; and that is it.&lt;/p&gt;
&lt;p&gt;Add below scripts to&amp;#xA0;IP/DHCP Client/WAN1 and&amp;#xA0;IP/DHCP Client/WAN2. You can do that via web config.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;For WAN1:&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plain hljs&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;{&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    :local count [/ip route print count-only where comment=WAN1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    :if ($bound=1) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        :if ($count = 0) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip route add gateway=$&amp;quot;gateway-address&amp;quot; routing-mark=WAN1 comment=WAN1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall nat add chain=srcnat out-interface=WAN1 action=masquerade comment=WAN1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting dst-address=$&amp;quot;gateway-address&amp;quot; action=accept in-interface=bridge comment=WAN1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip route add gateway=$&amp;quot;gateway-address&amp;quot; routing-mark=WAN1_out check-gateway=ping comment=WAN1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip route add gateway=$&amp;quot;gateway-address&amp;quot; distance=1 check-gateway=ping comment=WAN1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        } else={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            :if ($count &amp;gt; 1) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :local test [/ip route find where comment=WAN1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :if ([/ip route get $test gateway] != $&amp;quot;gateway-address&amp;quot;) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    /ip route set $test gateway=$&amp;quot;gateway-address&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;               :local test2 [/ip firewall mangle find where comment=WAN1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :if ([/ip firewall mangle get $test2 gateway] != $&amp;quot;gateway-address&amp;quot;) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    /ip route set $test2 gateway=$&amp;quot;gateway-address&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            } else={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :error &amp;quot;Multiple routes found&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    } else={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        /ip route remove [find comment=WAN1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        /ip firewall mangle remove [find comment=WAN1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        /ip firewall nat remove [find comment=WAN1]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;}&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;strong&gt;For WAN2:&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight plain hljs&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;{&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    :local count [/ip route print count-only where comment=WAN2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    :if ($bound=1) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        :if ($count = 0) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip route add gateway=$&amp;quot;gateway-address&amp;quot; routing-mark=WAN2 comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall nat add chain=srcnat out-interface=WAN2 action=masquerade comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting dst-address=$&amp;quot;gateway-address&amp;quot; action=accept in-interface=bridge comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting in-interface=WAN1 connection-mark=no-mark action=mark-connection new-connection-mark=WAN1_conn comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting in-interface=WAN2 connection-mark=no-mark action=mark-connection new-connection-mark=WAN2_conn comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting in-interface=bridge connection-mark=no-mark dst-address-type=!local protocol=tcp dst-port=22,80,443  per-connection-classifier=both-addresses:2/0 action=mark-connection new-connection-mark=WAN1_conn comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting in-interface=bridge connection-mark=no-mark dst-address-type=!local protocol=tcp dst-port=22,80,443  per-connection-classifier=both-addresses:2/1 action=mark-connection new-connection-mark=WAN2_conn comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting in-interface=bridge connection-mark=no-mark dst-address-type=!local per-connection-classifier=both-addresses-and-ports:2/0 action=mark-connection new-connection-mark=WAN1_conn comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting in-interface=bridge connection-mark=no-mark dst-address-type=!local per-connection-classifier=both-addresses-and-ports:2/1 action=mark-connection new-connection-mark=WAN2_conn comment=WAN2            &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting connection-mark=WAN1_conn in-interface=bridge action=mark-routing new-routing-mark=WAN1_out comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=prerouting connection-mark=WAN2_conn in-interface=bridge action=mark-routing new-routing-mark=WAN2_out comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=output connection-mark=WAN1_conn action=mark-routing new-routing-mark=WAN1_out comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip firewall mangle add chain=output connection-mark=WAN2_conn action=mark-routing new-routing-mark=WAN2_out comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip route add gateway=$&amp;quot;gateway-address&amp;quot; routing-mark=WAN2_out check-gateway=ping comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            /ip route add gateway=$&amp;quot;gateway-address&amp;quot; distance=2 check-gateway=ping comment=WAN2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        } else={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            :if ($count &amp;gt; 1) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :local test [/ip route find where comment=WAN2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :if ([/ip route get $test gateway] != $&amp;quot;gateway-address&amp;quot;) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    /ip route set $test gateway=$&amp;quot;gateway-address&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;               :local test2 [/ip firewall mangle find where comment=WAN2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :if ([/ip firewall mangle get $test2 gateway] != $&amp;quot;gateway-address&amp;quot;) do={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    /ip route set $test2 gateway=$&amp;quot;gateway-address&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            } else={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                :error &amp;quot;Multiple routes found&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    } else={&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        /ip route remove [find comment=WAN2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        /ip firewall mangle remove [find comment=WAN2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        /ip firewall nat remove [find comment=WAN2]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    }&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;}&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;For port 22,80,443 we use &amp;#x201C;both-addresses&amp;#x201D; as connection classifier to avoid HTTPS error or other authentication issues. Other ports we use both-addresses-and-ports so we can get maximum speed from both WANs.&lt;/p&gt;
&lt;p&gt;If you want to see the official doc of how to configure PCC in RouterOS. Here is the link: &lt;a href=&#34;https://wiki.mikrotik.com/wiki/Manual:PCC&#34;&gt;https://wiki.mikrotik.com/wiki/Manual:PCC&lt;/a&gt;&lt;/p&gt;
</content>
        <category term="tech" />
        <updated>2019-02-14T22:39:03.000Z</updated>
        <author>Evan Xu(Qualityology)</author>
    </entry>
</feed>